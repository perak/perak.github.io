/*!
 * Copyright (c) 2013 Petar KorponaiÄ‡
 *
 * All rights reserved
 */
;VideoCall=function(i){var x=this;this.localVideoStream=null;this.remoteVideoStream=null;this.isMaster=true;this.isActive=false;this.onLocalVideoStarted=null;this.onLocalVideoError=null;this.onLocalVideoStopped=null;this.onRemoteVideoStarted=null;this.onRemoteVideoStopped=null;this.onSendMessage=null;this.onLocalHangup=null;this.onRemoteHangup=null;this.onUnsupportedBrowser=null;var p=null;var b=false;var r=false;var n=[];this.startLocalVideo=function(){if(RTCPeerConnection==null||getUserMedia==null){if(typeof(onUnsupportedBrowser)!="undefined"&&onUnsupportedBrowser){onUnsupportedBrowser()}return}getUserMedia({audio:true,video:true},function(A){x.localVideoStream=A;if(typeof(onLocalVideoStarted)!="undefined"&&onLocalVideoStarted){onLocalVideoStarted()}},onLocalVideoError)};this.stopLocalVideo=function(){if(x.localVideoStream){x.localVideoStream.stop();x.localVideoStream=null}if(typeof(onLocalVideoStopped)!="undefined"&&onLocalVideoStopped){onLocalVideoStopped()}};this.waitCall=function(){x.isMaster=true;x.isActive=true;b=false;r=false;n=[];m()};this.initCall=function(){x.isMaster=false;x.isActive=true;b=false;r=false;n=[];m();var A=z(i.offerConstraints,i.sdpConstraints);p.createOffer(o,e,A)};this.hangupCall=function(){l();j({type:"bye"});if(typeof(onLocalHangup)!="undefined"&&onLocalHangup){onLocalHangup()}};this.processSignalingMessage=function(B){if(B.type==="offer"){h(B);k();b=true;while(n.length>0){x.processSignalingMessage(n.shift())}}if(B.type==="answer"){h(B);r=true;while(n.length>0){x.processSignalingMessage(n.shift())}}if(B.type==="candidate"){if(b||r){var A=new RTCIceCandidate({sdpMLineIndex:B.label,candidate:B.candidate});p.addIceCandidate(A)}else{n.push(B)}}if(B.type==="bye"){l();if(typeof(onRemoteHangup)!="undefined"&&onRemoteHangup){onRemoteHangup()}}};this.messageReceived=function(A){var B=JSON.parse(A);x.processSignalingMessage(B)};function m(){p=new RTCPeerConnection(i.pcConfig,i.pcConstraints);p.onicecandidate=q;p.onaddstream=c;p.addStream(x.localVideoStream)}function q(A){if(A.candidate){j({type:"candidate",label:A.candidate.sdpMLineIndex,id:A.candidate.sdpMid,candidate:A.candidate.candidate})}}function c(A){x.remoteVideoStream=A.stream;if(typeof(onRemoteVideoStarted)!="undefined"&&onRemoteVideoStarted){onRemoteVideoStarted()}}function h(A){if(i.stereo){A.sdp=w(A.sdp)}A.sdp=y(A.sdp);p.setRemoteDescription(new RTCSessionDescription(A),v,d)}function v(){}function d(A){console.log("onSetRemoteDescriptionError")}function e(A){console.log("onCreateOfferError")}function k(){p.createAnswer(o,g,i.sdpConstraints)}function g(A){console.log("onCreateAnswerError")}function o(A){A.sdp=f(A.sdp);p.setLocalDescription(A);j(A)}function j(A){var B=JSON.stringify(A);if(typeof(onSendMessage)!="undefined"&&onSendMessage){onSendMessage(B)}}function l(){x.isActive=false;if(typeof(remoteVideoStream)!="undefined"&&remoteVideoStream){remoteVideoStream.stop();remoteVideoStream=null}if(typeof(onRemoteVideoStopped)!="undefined"&&onRemoteVideoStopped){onRemoteVideoStopped()}if(p){p.close();p=null}b=false;r=false}function z(C,B){var A=C;for(var D in B.mandatory){A.mandatory[D]=B.mandatory[D]}A.optional.concat(B.optional);return A}function y(A){if(i.audio_send_codec==""){return A}return a(A,i.audio_send_codec)}function f(A){if(i.audio_receive_codec==""){return A}return a(A,i.audio_receive_codec)}function a(B,G){var D=G.split("/");if(D.length!=2){return B}var A=D[0];var E=D[1];var I=B.split("\r\n");for(var C=0;C<I.length;C++){if(I[C].search("m=audio")!==-1){var J=C;break}}if(J===null){return B}for(var C=0;C<I.length;C++){if(I[C].search(A+"/"+E)!==-1){var F=new RegExp(":(\\d+) "+A+"\\/"+E,"i");var H=t(I[C],F);if(H){I[J]=u(I[J],H)}break}}I=s(I,J);B=I.join("\r\n");return B}function w(A){var E=A.split("\r\n");for(var D=0;D<E.length;D++){if(E[D].search("opus/48000")!==-1){var B=t(E[D],/:(\d+) opus\/48000/i);break}}for(var D=0;D<E.length;D++){if(E[D].search("a=fmtp")!==-1){var F=t(E[D],/a=fmtp:(\d+)/);if(F===B){var C=D;break}}}if(C===null){return A}E[C]=E[C].concat(" stereo=1");A=E.join("\r\n");return A}function t(B,C){var A=B.match(C);return(A&&A.length==2)?A[1]:null}function u(B,E){var D=B.split(" ");var F=new Array();var A=0;for(var C=0;C<D.length;C++){if(A===3){F[A++]=E}if(D[C]!==E){F[A++]=D[C]}}return F.join(" ")}function s(B,F){var D=B[F].split(" ");for(var A=B.length-1;A>=0;A--){var E=t(B[A],/a=rtpmap:(\d+) CN\/\d+/i);if(E){var C=D.indexOf(E);if(C!==-1){D.splice(C,1)}B.splice(A,1)}}B[F]=D.join(" ");return B}};